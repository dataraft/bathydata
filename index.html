<!DOCTYPE html>
<html lang="en">
<head >
	<meta charset="utf-8" />
  <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">

<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.css' rel='stylesheet' />

 <link rel="icon" href="images/favicon.ico" type="image/x-icon">
 <title>Oceanographic database</title>
</head>
<body style='margin:0 !important; padding:0 !important'>
	<script
			  src="https://code.jquery.com/jquery-3.2.1.min.js"
			  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			  crossorigin="anonymous"></script>
	
	<script src="https://unpkg.com/vue-router@2.0.0/dist/vue-router.js" > </script>

	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.css' rel='stylesheet' />
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.1.0/leaflet.polylineDecorator.min.js"></script>
<script type="text/javascript" src="browser_detect.js"></script>
   
   <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<link rel="stylesheet" href="style.css" />	
    <link rel="stylesheet" href="login/style.css" />
    <link rel="stylesheet" href="pricing/style.css" />
    <link rel="stylesheet" href="nouislider.css" />
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css">
    <script type="text/javascript" src="bootstrap.min.js"></script>
     <script type="text/javascript" src="nouislider.min.js"></script>
     <script type="text/javascript" src="wNumb.js"></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
	<nav style="background-color: #fcfcfc; position: absolute; z-index: 1000; height:7vh; line-height: 7vh !important;">
    <div class="nav-wrapper">
      <a href="#" class="brand-logo" style="color:#004165; padding-left: 20px; font-weight: 400;">   SAMUDRA   </a> 
      <!-- <span> Oceanographic Database</span> -->    
      <ul id="nav-mobile" class="right hide-on-med-and-down">
        <li><a href="#faq" class=" modal-trigger" > FAQ </a></li>
        <!--<li><a href="#pricing"   class=" modal-trigger" onclick="pricing()" > Subscription </a></li>-->
        <li><a href="#upload" class=" modal-trigger" > Upload Data </a></li>
        <li><a href="#contact" class=" modal-trigger" > Contact Us </a></li>
        <li><a href="#aboutus" class=" modal-trigger" > About Us </a></li>
        <!--<li><a href="#"  > <button type="button" data-target="select-area" class="btn modal-trigger">Select-Area </button></a></li>-->
        <li><a href="#login" id="login-btn"   class=" modal-trigger"><button type="button" class="btn"> Login </button> </a></li>
        <li id="logout-btn" style="display:none"><a class='dropdown-button ' href="#logout" data-activates='dropdown1' id="login-text"   >   </a> <span class="badge" style="right:0; top:5vh; padding-left: 0;"> <i class="material-icons tiny" style="height:0.8vh; line-height: 0.8vh">arrow_drop_down</i></span> </li> <ul id='dropdown1' class="dropdown-content" > <li> <a href="#" onclick="logout()"> Logout </a> </li> 
        </ul>
         <!-- <li><a href="collapsible.html">Checkout</a></li> -->
      </ul>
    </div>
  </nav>
  <div id="login" class="modal">
    <div class="modal-content">
      <div class="login-page">
                  <div class="form">
                    <form id="register-form" class="register-form">
                        <!-- <button onclick="choose_area()">Choose your plan </button> -->
                      <input type="text" required placeholder="name"/>
                      <input type="email" required placeholder="email address"/>
                      <input type="password" required placeholder="password"/>
                      <input type="number" required placeholder="contact number"/>
                      <input type="text" required placeholder="Organisation"/>
                      <button type="button" onclick="signup()">NEXT</button>
                      <p class="message">Already registered? <a href="#">Sign In</a></p>
                    </form>
                    <form id="login-form" class="login-form">
                      <input type="text" required placeholder="username"/>
                      <input type="password" required placeholder="password"/>
                      <button type="button" onclick="login()">login</button>
                      <p class="message">Not registered? <a href="#">SignUp</a></p>
                    </form>
                  </div>
        </div>
    </div>
     <div class="modal-footer">
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Close</a>
    </div>
  </div>
  <div id="select-area" class="modal modal-fixed-footer">
                  
    <div class="modal-content" style="height: 68vh"> 
    <div id='map2' style=" width: 100%; height: 85%"></div>
    <label style="float: left;">Click on the highlighted regions to choose the zone </label>
          <div class="chips chips-initial "></div>
    </div>
    <div class="modal-footer">        
        
          
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn " onclick="register()"> Register </a>
    </div>
  </div>
  <div id="upload" class="modal">
    <div style="text-align: center;color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> Upload Data </div>
    <div style="max-width: 50%;padding-left:10%">
      <form id='upload-form'>
        Data: <select  id="data-type" name="data-type">
                <option value="bathymetry" selected>Bathymetry</option>
                <option value="shoreline">Shoreline</option>
              </select><br/><br/>
        CSV:  <input id="csv-file" type="file" name='csv-file' accept=".csv"/><br/><br/>
        Name: <input id="zone-name" type="text" name='name'/><br/><br/>
      <button type="button" class="btn" onclick="uploadData()"> Upload </button><br/><br/>
      </form>
    </div>
  </div>
  <div id="faq" class="modal">
    <div style="text-align: center;color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> Frequently Asked Questions </div>
    <div style="padding-left: 20px"><b> What is the data resolution available for download?</b></div>
    <div style="padding-left: 20px"> wave height, period, direction - 0.25 degrees.</div>
    <div style="padding-left: 20px"> bathymetry(coarse) - 900m.</div>
    <div style="padding-left: 20px"> bathymetry(HD, red zones) - 2m.</div><br/><br/>
    <div style="padding-left: 20px"><b> Why am I unable to draw a polygon across multiple zones?</b></div>
    <div style="padding-left: 20px"> Polygon should be limited to a single subscribed zone. You cannot draw a polygon across multiple zones.</div><br/><br/>
  </div> 
  <div id="contact" class="modal" style="text-align: center;">
    <span style="color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> Contact Us </span>
    <div>For any queires or requests please contact us at</div><br>
    <div><b>Email:</b> help@dataraft.in</div><br/>
    <div><b>Phone:</b> +91 7827824852</div><br/>
    <div><b>Address:</b> 03-A2 3rd Floor, IITM Research Park, Kanagam Road, Taramani, Chennai, Tamil Nadu - 600113</div><br/>
  </div>
  <div id="aboutus" class="modal" style="text-align: center;">
    <span style="color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> About Us </span>
    <button class="modal-close btn-flat" style="position:absolute;top:0;right:0;">
      <i class="material-icons">close</i>
            </button>
            <div class="modal-content">
            <div class="row">
                <div class="col s12 m4">
                <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/Prof_SUNDAR.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4">Prof.V.Sundar, IIT Madras<i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/vsundar/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.V.Sundar, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

            <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/prof_murali.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.K.Murali, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/murali/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.K.Murali, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

              <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/prof_Sannasiraj.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.Sannasiraj, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/sasraj/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.Sannasiraj, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

               
          </div> 
            <div class="row">

                <div class="col s12 m4">
                <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/Assi_Prof_sriram.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.V.Sriram, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/vsriram/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.V.Sriram<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

              <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/dr.chitra.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Dr.K.Chitra <i class="material-icons right">more_vert</i></span>
                  <p><a href="#" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Dr.K.Chitra<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

            </div>
            </div>
            
  </div>   
  <div id="pricing" class="modal modal-fixed-footer">

    <div class="modal-content">
      <section class="container">
              <div class="row white">
                            <div class="block">

                                <div class="col-xs-12 col-sm-6 col-md-3" style="float:left; width: 50%!important;">
                                        <ul class="pricing p-green">
                                            <li>
                                                <img src="" alt="">
                                                <big>Plan A</big>
                                            </li>
                                            <li>Basic Resolution Data</li>
                                            <li>25 Downloads per month</li>
                                            <li>1 GB Cloud Storage </li>
                                            <li>
                                                <h3>$199</h3>
                                                <span>per month</span>
                                            </li>
                                        </ul>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-md-3" style="float: right; width: 50% !important;">
                                        <ul class="pricing p-blue">
                                            <li>
                                                
                                                <big>Plan B</big>
                                            </li>
                                            <li>High Resolution Data</li>
                                            <li>100 Downloads per month</li>
                                            <li>5 GB Cloud Storage</li>
                                            <li>
                                                <h3>$799</h3>
                                                <span>per month</span>
                                            </li>
                                        </ul>
                                </div>


                            </div><!-- /block -->
                        </div><!-- /row -->
             </section>

    </div>
    <button class="modal-close btn-flat" style="position:absolute;top:0;right:0;">
      <i class="small material-icons">close</i>
            </button>
    <div class="modal-footer">
        <span style="float:left;" id="planid"></span>    
      <!--<a href="#!" class="modal-action modal-close waves-effect waves-green btn ">Submit</a>-->
    </div>
  </div>

	<div id='map' style='position:absolute; top:0; bottom:0; width: 100%;'></div>
  <pre id='latlng-display'></pre>
	<div style="position: absolute; top:64px;left:0px; width:20vw;  z-index: 100">
	  <ul class="collapsible" data-collapsible="accordion">
	    <li>
	      <div class="collapsible-header active">1. Choose Data type </div>
	      <div class="collapsible-body" id="div-sel-data"><label for="data_types"> Data types </label><div id="data_types" class="input-field col s6">
          <select  id="sel-data-type">
            <option value="waveheight" selected >Wave Height</option>
            <option value="wavedirection">Wave Direction</option>
            <option value="waveperiod">Wave Period</option>
            <option value="bathymetry">Bathymetry </option>
            <option value="tide">Tide </option>
            <option value="current">Current </option>
          </select>
        </div>
        <div id="div-sel-month">
          <label for="sel-month">Month</label>
          <select  id="sel-month">
            <option value="1" selected >January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
	      <!-- <div id="dates">
          <label for="datefrom">From</label>
	      <input type="date" id="datefrom" class="datepicker col s6 m2"> 
	      <label for="dateto">To </label>
	      <input type="date" id="dateto" class="datepicker col s6 m2">
         </div> -->
          <!-- <label for="switch">Data Resolution </label>
          <div id="switch" class="input-field col s12">
            <select onchange="changeFunc(value);">
              <optgroup label="Free Plan">
                <option value="1">BASIC</option>
              </optgroup>
              <optgroup label="Premium Plan">
                <option value="2" disabled>NORMAL</option>
                <option value="3" disabled>HIGH</option>
              </optgroup>
            </select>
          </div> -->
	  </div>
	    </li>
	    <li>
	      <div class="collapsible-header">2. Select your area</div>
	      <div class="collapsible-body"><span> <p> Draw a polygon in a subscribed(green) zone. </p> <button class="btn" id="draw"> Draw</button> <!-- <button id="edit"> Edit </button> --> <div id='calculated-area'></div></span> </div>
	    </li>
	    <li>
	      <div class="collapsible-header">3. Download </div>
	      <div class="collapsible-body"> <div class="row">
    <!-- <form class="col s12">
      <div class="row">
        <div class="input-field col s12">
          <input id="email" type="email" class="validate">
          <label class="active" for="email" data-error="wrong" data-success="right">Email</label>
        </div>
      </div>
      <div class="input-field col s12">
      <input value="dataraft" id="organisation" type="text" class="validate">
      <label  for="organisation">Organisation</label>
    </div>
    </form> -->

  </div> <div><button class="btn" id="submit"> Download </button></div> 
	    </li>
	  </ul>
      </div>

     <div  class="legend-box">
     			<figure class="map-leg-d-1" style="color:#cecccc"> </figure>  <span style="font-size: 10px;position: relative;top: -5px;"> zones </span> </br>
        <figure class="map-leg-d-1" style="color:#00ff00"> </figure>  <span style="font-size: 10px;position: relative;top: -5px;"> subscribed zones </span> </br>
        <figure class="map-leg-d-1" style="color:#ff0000"> </figure> <span style="font-size: 10px;position: relative;top: -5px;"> hd bathymetry </span> </br>
        <figure class="map-leg-d-1" style="color:#0000ff"> </figure> <span style="font-size: 10px;position: relative;top: -5px;"> user bathymetry </span> </br>
        <figure class="map-leg-d-2" style="color:#FFF700"> </figure> <span style="font-size: 10px;position: relative;top: -5px;"> current shoreline </span> </br>
        <figure class="map-leg-d-2" style="color:#FFAA1D"> </figure> <span style="font-size: 10px;position: relative;top: -5px;"> past shoreline </span> </br>
    </div>
 <div id="year-slider"></div>
 <div id="year-slider-start"></div>  


<div class="preloader-wrapper active" id="loader">
      <div class="spinner-layer spinner-green-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div><div class="gap-patch">
          <div class="circle"></div>
        </div><div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>

<div id="browser_detect_modal" class="modal">
  <div class="modal-content" style="text-align: center;">
      <h4>Browser Unsupported</h4>
      <p>Please download latest <a href="https://www.mozilla.org/en-US/firefox/new/" target="_blank">Mozilla Firefox </a> or <a href="https://www.google.com/chrome/browser/desktop/" target="_blank" >Chrome</a> browsers.</p>
    </div>
</div>
	<script>

        //****************************************************Global varaibles*************************************************//
        var protocol = location.protocol;

	      var slashes = protocol.concat("//");
	      var host = slashes.concat(window.location.hostname);
        host = host.concat(':'+window.location.port);
	      //var host = 'http://14.139.160.45:8080';
        var zone; //zones the user needs to update
        var zone_local=[]; // store the zone names and ids in local.
        var zone_array=[];  
        
        var satellite_layer; // tiles
        var boundary_layer;
        var boundary_zones = []; // boundary zone features
        var boundary_triangles = []; // color coding features
        var shoreline_json = [];
        var subscribed_layer
        var bathymetry_layer;
        var shoreline_layer=[];  // all shorelines 
        var bathymetry_zones = []; // bathymetry zone features
        var bathymetry_triangles = []; // color coding features  //bathy zone 
        var visualisation_triangles = []; // color coding features  //subscribed zone 
        var user_zones_layer;
        var user_zones = []; // user zone features
        var triangulation_layers = [];
        var s_first_load =0; //check if shoreline default layer is loaded.   
        var s_latest_year = 2017 //the shoreline display latest year on slider. Also the dfault location of slider. 

        var pricing_flag ;
        var inputs_register ;
        var plan_variable; //plan a or b
        var maps = {};
        
        var session_api = host+'/download/login/';
        var login_api = host+'/download/login/?email=';
        var signup_api = host+'/download/signup/?email=';
        var price_api = host+'/download/price/?';
        var point_api = host+'/download/point/?';
        var order_api = host+'/download/order/?';
        var logout_api = host+'/download/logout/';
        var upload_api = host+'/download/upload/';
        var triangular_api = host+'/download/zonedata?zid=';
        var shoreline_api = host+'/download/shoreline/?year='
        var user_details;
        var login_flag = false;
        var data_type = 'wave';
        var intersect = false;
        var dates;      //datatype.from_date/to_date
        var d_chose_from = '2017-10-10';      //download data date range
        var d_chose_to = '2017-12-25';
        var month = 1;
        var loader = document.getElementById('loader');

        // map related //
        var heatmap_data;
        var method = "GET";
        var async = true;
        var request = new XMLHttpRequest();
        var datatype;
        var email;
        var organisation;
        var geo_json_data = {}; //user drawn coordinates jeojson
        var calcButton = document.getElementById('calculate');   
        var datefrom;   
        var dateto;
        var polygon_check = false;
        var map;

        
        //*********************************************Loading Map2**********************************************//
        session_call = function(url,val){
            console.log(val + url);
        var client = new XMLHttpRequest();
        client.onreadystatechange = function(){
            var response = JSON.parse(this.responseText);
            if(this.readyState == 4 && this.status==200){
            if(response.status){
                user_details = response.data;
                dates = user_details.dates;
                //change_dates('waveheight');
                console.log(user_details);
                       login_flag = true;
            login_flip(); 
            load_zones();
            shoreline_update();   
            if(val==1) {
            $('#login').modal('close');
            }
            }
            else {                  //val =1 implies coming from login
                if(val==1){
                alert(response.msg);
                }
            }
           } 
           else if(this.readyState ==4 && this.status==500){
            alert('Hi, the server is under maintainenace. Please try after some time.');
           }
        }
	client.open('GET', url, true);
	client.setRequestHeader('Content-Type', 'application/json');
	client.withCredentials = true;
        client.send();
        }
        
        L.mapbox.accessToken = 'pk.eyJ1Ijoic2hhc2hhbmsxOTkyIiwiYSI6ImNqODFneGcxNjZ2Z2EycXQ2a21kc3g5MnkifQ.93wfkOvX-_T9RrDA6PXmMA';
        
        maps.map2 = L.mapbox.map('map2','mapbox.streets').setView([13,80],5);
        var boundary_client = new XMLHttpRequest();
        
        boundary_client.open('GET',host+'/download/zone/',async)
        boundary_client.setRequestHeader("Content-type","application/json;charset=UTF-8");
        boundary_client.onreadystatechange = function(){
            if(boundary_client.readyState==4 && boundary_client.status==200){
            boundary_zones = JSON.parse(boundary_client.responseText).zones;
            // feature format
            for (var i=0; i<boundary_zones.length; i++) {
              boundary_zones[i] = {'type':'Feature', 'properties':{'zid':boundary_zones[i].zid, 'name':boundary_zones[i].name}, 'geometry':boundary_zones[i].polygon};
            }
            
            //bathymetry zones 
            bathymetry_zones = JSON.parse(boundary_client.responseText).bathymetry;
            for (var i=0; i<bathymetry_zones.length; i++) {
              // triangle features
              if (bathymetry_zones[i].triangles && bathymetry_zones[i].triangles.length) {
                bathymetry_zones[i].triangles.forEach(function (t) {
                  bathymetry_triangles.push({'type':'Feature','properties':{'depth':t[1]}, 'geometry': {'type': 'Polygon', 'coordinates': [t[0]]}});
                });
            }

              bathymetry_zones[i] = {'type':'Feature', 'properties':{'zid':bathymetry_zones[i].zid, 'name':bathymetry_zones[i].name}, 'geometry':bathymetry_zones[i].polygon};
            }
            
            boundary_layer = L.mapbox.featureLayer({type:"FeatureCollection", features:boundary_zones}).addTo(maps.map2)
            boundary_layer.eachLayer(function(layer){
                console.log(layer.feature.properties);
                zone_local.push(layer.feature.properties);
                console.log(zone_local);
                layer.bindPopup('The Zone Id is ' + layer.feature.properties.name);
                layer.on('mouseover',function(){
                    layer.openPopup();
                })
                layer.on('mouseout',function(){
                    layer.closePopup();
                })  
                layer.on('click',function(){
                    check_chip_duplicate({'tag':layer.feature.properties.name});
                    $('.chips-initial').material_chip({'data':zone_array});
                    console.log($('.chips-initial').material_chip('data'));

                })

                // layer.on('click',function(e){
                //     console.log(e.target.feature.properties.name);

                // })
             })
             addTomap();
             session_call(session_api,0);
           }  
           else if(boundary_client.readyState ==4 && boundary_client.status==500){
            alert('Hi, the server is under maintainenace. Please retry to get the list of zones.');
           }
        };  
        boundary_client.send();      
        
        shoreline_update = function(val){
          console.log(val);
          var year,date;
          shoreline_json=[];
          if(val) { 
            console.log(val);
          date = new Date(Number(val));
          year = date.getFullYear();
        }
        else year = s_latest_year;
        if(year == s_latest_year && s_first_load ==1) return;
        var shoreline_client = new XMLHttpRequest();
        shoreline_client.open('GET',shoreline_api+year,async);
        shoreline_client.onreadystatechange = function(){
          if(shoreline_client.readyState==4 && shoreline_client.status==200){
            shorelines = JSON.parse(shoreline_client.responseText).shoreline;
            // features
            if(shorelines.length){
            for(var i=0;i<shorelines.length;i++) {
              var s = {};
              s.geometry = shorelines[i];
              s.type = 'Feature';
              s.properties = shorelines[i].properties;
              shoreline_json.push(s);
            }
            }
            console.log('shoreline');
            console.log(shoreline_json);

            if (shoreline_json.length) {
              if(shoreline_layer.length==0){
                s_first_load = 1;
              shoreline_layer[0] = L.mapbox.featureLayer({type:'FeatureCollection',features:shoreline_json}, {style: function() {return {color: "#FFF700",weight: 3,fillOpacity:0.05};}}).addTo(map);
              }

              else {
                if(shoreline_layer.length>1)  map.removeLayer(shoreline_layer[1]);
                if(year == s_latest_year && s_first_load ==1) return;
                shoreline_layer[1] = L.mapbox.featureLayer({type:'FeatureCollection',features:shoreline_json}, {style: function() {return {color: "#FFAA1D",weight: 3,fillOpacity:0.05};}}).addTo(map);
              };
            }
            for (i=0;i<shoreline_layer.length;i++){
            shoreline_layer[i].eachLayer(function(layer){
              layer.bindPopup('Shoreline dated ');
              layer.on('mouseover',function(){
                    layer.openPopup();
                })
                layer.on('mouseout',function(){
                    layer.closePopup();
                })  
            })
            }
          }
          else if(shoreline_client.readyState==4&& shoreline_client.status==500) {
            alert('Hi, the server is under maintainenace. Please retry after some time.');
          }
        }
        shoreline_client.withCredentials=true;
        shoreline_client.send();
        
      }

      shoreline_update();
  //***************************************************************jquery document.ready initializations*******************//      
    	$(document).ready(function() {
        $('select').material_select();
        $(".button-collapse").sideNav();
        $('.modal').modal({
            inDuration:0,
            outDuration:0  
        });
        if( $('#sel-data-type').val() == 'bathymetry' ) {document.getElementById("dates").style.display="none"; data_type='bathymetry'};
        $('#select-area').modal({
            inDuration:0,
            outDuration:0,
            ready:function(){
                maps.map2.invalidateSize();        
            },
            complete:function(){
                
            }

        });
        $("#browser_detect_modal").modal();


        addCloseHandler($('#browser_detect_modal'), function (close) {
          return;
        }); 

        detect(); //initialize browser detection



        $('.dropdown-button').dropdown({
            hover:true,
            belowOrigin : true,
            alignment:'right',
            constrainWidth: false  
        })

            // $('#pricing').modal({
            //     inDuration:0,
            //     outDuration:0,
            //     complete:function(){
            //         if(pricing_flag) { pricing_flag = false; return};
            //         $('#planid').empty().html('');
            //         register();
            //         pricing_flag = false;
            //     }
            // })
        });

   ///************************************************************material chips ****************************//

        $('.chips-initial').on('chip.delete',function(e,chip){
            var index = zone_array.findIndex(x=> x.tag==chip.tag);
            if(index>-1){
                zone_array.splice(index,1);
            }
        });
        $('.chips-initial').on('chip.add',function(e,chip){
          check_chip_duplicate(chip);     
        })
        $('.chips-initial').material_chip({
            data:[],
            placeholder: 'Enter a tag',
            secondaryPlaceholder: '+Tag',
            minLength:1
        });
        
        check_chip_duplicate = function(chip) {
          var index = zone_array.findIndex(x=> x.tag==chip.tag);
          if(index==-1) { zone_array.push(chip);  } 
        }
  //*******************************************************ui functions & setting global variables*********************************//

        $("#sel-data-type").on('change',function(){
            data_type = $('#sel-data-type').val();
            var el = document.getElementById('div-sel-month');
            if(data_type=='bathymetry') { el.style.display = 'none'}
                else el.style.display='';
              //console.log(dates);
            // if(dates && dates[data_type]) {
            //   change_dates(data_type);
            // }
            
        });
        change_dates = function(type){
          console.log('changing dates');
          d_chose_from = dates[type].from_date;
          d_chose_to =   dates[type].to_date;
          picker.set('min', new Date(d_chose_from));
          picker.set('max',new Date(d_chose_to));

        }
        plan_option = function(val){
            plan_variable = val;
            $('#planid').empty().html('You have chosen Plan'+val);
            
        }

        signup = function() {
            inputs_register = document.getElementById('register-form').elements;
            choose_area();
            
        }


        pricing = function(){
            pricing_flag = true;
        }

        login_form_reset = function(){
            document.getElementById('register-form').reset();
            document.getElementById('login-form').reset();
            $('.chips-initial').material_chip({'data':[]});
        }
        select_area_next = function(){
                    $('#pricing').modal('open');
                    zone = $('.chips-initial').material_chip('data');
        }
        choose_area = function(){
            $('#login').modal('close');
            $('#select-area').modal('open');
        }

        form_reset = function(){
            document.getElementById('sel-data-type').reset();
            document.getElementById('datefrom').reset();
            document.getElementById('dateto').reset();
        }

        clearVisualisation = function() {
          if (triangulation_layers.length) {triangulation_layers.forEach(function (l) {map.removeLayer(l)});};
          visualisation_triangles = [];
        }
        
        var doubleclicked = false;

        function load_zones() {
          var subscribed_zones = [];
            
          if(login_flag){
              console.log('went in');

            // add subscribed layer
            var zids = user_details.subscription_zones;   
            for(var i=0;i<zids.length;i++) {
                var ind = boundary_zones.findIndex(x => x.properties.zid == zids[i]);
                subscribed_zones.push(boundary_zones[ind]);
            }         
              subscribed_layer = L.mapbox.featureLayer({type:"FeatureCollection", features: subscribed_zones}, {style: function() {return {color: "#00ff00",weight: 3,fillOpacity:0.05};}}).addTo(map);

              // map point API
              subscribed_layer.on('click', function(e) {
                setTimeout(function() {
                  if (!doubleclicked) {pointData(e.latlng);}
                }, 100);
              });

              // visualisation
              subscribed_layer.eachLayer(function(layer){
                console.log(layer.feature.properties);
                layer.on('dblclick',function(){
                  //prevent click event for 1 sec
                  doubleclicked = true;
                  setTimeout(function(){doubleclicked=false;}, 1000);

                  console.log(layer.feature.properties.zid);
                  // clear layer
                  clearVisualisation();

                  $.ajax({
                     type : 'GET',
                     url : triangular_api+layer.feature.properties.zid,
                     dataType: 'json',
                     cache: false,
                     xhrFields: {withCredentials: true},
                     crossDomain: true,
                      success : function(response) {
                        if(response.status) {
                           // display pop-up
                           //console.log(response);
                           var vis_type = $('#sel-data-type')[0].value;

                           var data = response;
                           if (data.triangles && data.triangles.length) {
                              data.triangles.forEach(function (t) {
                                visualisation_triangles.push({'type':'Feature','properties':{'wave_height':t[1], 'wave_direction':t[2], 'wave_period':t[3], 'bathymetry':t[4], 'tide':t[5], 'current_speed':t[6][0], 'current_direction':t[6][1]}, 'geometry': {'type': 'Polygon', 'coordinates': [t[0]]}});
                              });
                           }

                          if (vis_type=='waveheight' || vis_type=='waveperiod' || vis_type=='bathymetry' || vis_type=='tide') {
                            if (visualisation_triangles.length) {
                              // add layer
                              var vis_style = waveheight_Style;
                              if (vis_type=='bathymetry') {vis_style = bathymetry_Style;}
                              
                              triangulation_layer = L.mapbox.featureLayer({type:"FeatureCollection", features: visualisation_triangles}, {style: vis_style}).addTo(map,true);
                              triangulation_layers.push(triangulation_layer);
                              // clear layer
                              triangulation_layer.on('dblclick', function () {
                                 clearVisualisation();
                              });
                            }
                          } else if(vis_type=='wavedirection' || vis_type=='current') {
                            var polylines = [];
                            visualisation_triangles.forEach(function (t) {
                              var tri = t['geometry']['coordinates'];
                              var centroid = [(tri[0][0][0]+tri[0][1][0]+tri[0][2][0])/3, (tri[0][0][1]+tri[0][1][1]+tri[0][2][1])/3];
                              if (vis_type=='wavedirection') {
                                var max_waveheight = 0.5;
                                var waveheight = t['properties']['wave_height'];
                                var wavedirection = t['properties']['wave_direction'];
                                if (waveheight && wavedirection) { // draw arrow
                                  var m = Math.abs(Math.tan(wavedirection * Math.PI/180));
                                  var k = 0.1*(waveheight/max_waveheight)/Math.sqrt(1+m*m);
                                  var new_point = [centroid[0]+(k*1), centroid[1]+(k*m)];
                                  var arrow = L.polyline([L.latLng(centroid[1], centroid[0]), L.latLng(new_point[1], new_point[0])], {smoothFactor: 0, noClip: true});
                                  var arrowHead = L.polylineDecorator(arrow, {
                                      patterns: [
                                          {
                                              offset: '100%',
                                              repeat: 0,
                                              symbol: L.Symbol.arrowHead({pixelSize: 8, polygon: false, pathOptions: {fillOpacity: 1, weight: 1}})
                                          }
                                      ]
                                  });
                                  polylines.push(arrow);
                                  polylines.push(arrowHead);
                                }
                              } else if(vis_type=='current') {
                                var max_speed = 0.5;
                                var speed = t['properties']['current_speed'];
                                var currentdirection = t['properties']['current_direction'];
                                if (speed && currentdirection) { // draw arrow
                                  var m = Math.abs(Math.tan(currentdirection * Math.PI/180));
                                  var k = 0.1*(speed/max_speed)/Math.sqrt(1+m*m);
                                  var new_point = [centroid[0]+(k*1), centroid[1]+(k*m)];
                                  var arrow = L.polyline([L.latLng(centroid[1], centroid[0]), L.latLng(new_point[1], new_point[0])], {smoothFactor: 0, noClip: true});
                                  var arrowHead = L.polylineDecorator(arrow, {
                                      patterns: [
                                          {
                                              offset: '100%',
                                              repeat: 0,
                                              symbol: L.Symbol.arrowHead({pixelSize: 8, polygon: false, pathOptions: {fillOpacity: 1, weight: 1}})
                                          }
                                      ]
                                  });
                                  polylines.push(arrow);
                                  polylines.push(arrowHead);
                                }
                              }
                            });
                            // add layer
                            triangulation_layer = L.layerGroup(polylines).addTo(map,true);
                            triangulation_layers.push(triangulation_layer);
                            // clear layer
                            triangulation_layer.on('dblclick', function () {
                              clearVisualisation();
                            });
                          }
                        } else{
                        alert(response.msg);
                         }
                      },
                      error : function(xhr) {
                        alert('Server is down. Please try after sometime.');
                      },
                    });
                });
            });

            // add user zones layer
            var userzones = user_details.userzones;
            for(var i=0;i<userzones.length;i++) {
              var z = {};
              z.geometry = userzones[i][1];
              z.type = 'Feature';
              z.properties = {'uzid': userzones[i][0]};
              user_zones.push(z);
            }
            user_zones_layer = L.mapbox.featureLayer({type: "FeatureCollection", features: user_zones}, {style: function() {return {color: "#0000ff",weight: 3,fillOpacity:0.05};}}).addTo(map);

          }
        };
// login js
    $('.message a').click(function(){
       $('form').animate({height: "toggle", opacity: "toggle"}, "slow");
    });

    var $input = $('.datepicker').pickadate({
      min: new Date(d_chose_from),
      max: new Date(d_chose_to),
      selectMonths: true, // Creates a dropdown to control month
      //selectYears: 15, // Creates a dropdown of 15 years to control year,
      today: 'Today',
      clear: 'Clear',
      close: 'Ok',
      closeOnSelect: false, // Close upon selecting a date
      onClose: function(){
        console.log('caleder closed');
        $('.picker').blur();
        $('.datepicker').blur();
    }
  });
    var picker = $input.pickadate('picker');

    function changeFunc($i){
        console.log($i);
    }



//**************************************************************register & login******************************//

login = function(){
    console.log('clicked');
    var inputs = document.getElementById('login-form').elements;
    var url = login_api + inputs[0].value + '&password='+inputs[1].value;  //login fields are bound to the form change if changed in the form
    session_call(url,1);
}


register = function(){
    var zone_list=[];
    for(i=0;i<zone_array.length;i++){
        var index = zone_local.findIndex(x=> x.name == zone_array[i].tag);
        console.log(zone_local & index);
        zone_list.push(zone_local[index].zid);
    }
    console.log(zone_list);
    var url = signup_api+inputs_register[1].value+'&password='+inputs_register[2].value+'&organization='+inputs_register[4].value+'&phone='+inputs_register[3].value+'&name='+inputs_register[0].value+'&subscription_zones='+JSON.stringify(zone_list)+'&subscription_type='+plan_variable;
    var client = new XMLHttpRequest();
    client.onreadystatechange = function(){
        if(this.readyState == 4 && this.status==200) {
          var r = JSON.parse(client.responseText);
          console.log(r.status);
          if(r.status) { alert('Your registration is successful. You will get an email once we activate your account.'); login_form_reset(); }
          else { alert(r.msg); }
        }
        else if(this.readyState ==4 && this.status==500){
            alert('Hi, the server is under maintainenace. Your registration is invalid.');
           }
    }
    client.open('GET',url);
    client.send();
}

function logout(){
    var client = new XMLHttpRequest();
    client.onreadystatechange = function(){
	if(this.readyState == 4 && this.status==200) {
            login_flag = false;
            login_flip();
            user_details=[];
             location.reload();
	}
  else if(this.readyState ==4 && this.status==500){
            alert('Hi, the server is under maintainenace. Could not logout.');
           }
    }
    client.open('GET', logout_api);
    client.send();    
}

function login_flip() {
    if(login_flag){
        $('#login-text').html(user_details.email);
    document.getElementById('login-btn').style.display = 'none';
    document.getElementById('logout-btn').style.display = '';

    }
    else {
        document.getElementById('login-btn').style.display = '';
        document.getElementById('logout-btn').style.display = 'none';
    }
}



//****************************************************       map           **************************************//
function addTomap() {   //ADD zones and bathymetry to map
    boundary_layer = L.mapbox.featureLayer({type:"FeatureCollection", features:boundary_zones}, {style: function() {return {color: " #cecccc",weight: 3,fillOpacity:0.05};}
            }).addTo(map,true);

    if (bathymetry_triangles.length) {
      triangulation_layer = L.mapbox.featureLayer({type:"FeatureCollection", features:bathymetry_triangles}, {style: bathymetry_Style}).addTo(map,true);
    }

    bathymetry_layer = L.mapbox.featureLayer({type:"FeatureCollection", features:bathymetry_zones}, {style: function() {return {color: " #ff0000",weight: 3,fillOpacity:0.05};}}).addTo(map,true);

    // bathymetry_layer.on('click', function (e) {
    //   target = e.target;
    // });

    bathymetry_layer.eachLayer(function(layer){

      console.log(layer.feature.properties);
      layer.on('dblclick',function(){
        console.log(layer.feature.properties.zid);
        $.ajax({
       type : 'GET',
       url : triangular_api+layer.feature.properties.zid,
       dataType: 'json',
       cache: false,
       xhrFields: {
       withCredentials: true
      },
    crossDomain: true,
       success : function(response) {
          if(response.status) {
            // display pop-up
            
            console.log(response);
            var data = response;
            if (data.triangles && data.triangles.length) {
                data.triangles.forEach(function (t) {
                  bathymetry_triangles.push({'type':'Feature','properties':{'depth':t[1]}, 'geometry': {'type': 'Polygon', 'coordinates': [t[0]]}});
                });
            }

            if (bathymetry_triangles.length) {
        triangulation_layer = L.mapbox.featureLayer({type:"FeatureCollection", features:bathymetry_triangles}, {style: bathymetry_Style}).addTo(map,true);
        }

          } else{
            alert(response.msg);
          }
       },
       error : function(xhr) {
         alert('Server is down. Please try after sometime.');
       },
    });

      });
    });

    loader.style.display='none';
}

 map = L.mapbox.map('map','mapbox.streets-satellite', {attributionControl: false}).setView([22,78],5);
 map.doubleClickZoom.disable();
 satellite_layer = L.mapbox.tileLayer('mapbox.streets-satellite'); 

 satellite_layer.on('ready', updateAttribution);
 map.on('mousemove', latlngDisplay);

 function updateAttribution() {
 	var credits = L.control.attribution({prefix:false}).addTo(map);
		credits.addAttribution('&copy; Shatej Technologies');

		var atags = Array.from(document.getElementsByClassName( 'leaflet-control-attribution' )[1].getElementsByTagName('a'));
	 atags.forEach(function (a) {a.remove();})
 }

map.on("click", function (event) {
  var clickedLayers = leafletPip.pointInLayer(event.latlng, bathymetry_layer);
  // Do something with clickedLayers
  clickedLayers.forEach(function(layer){
    layer.fireEvent('click',{
      latlng: event.latlng,
      layerPoint : event.layerPoint,
      containerPoint: event.containerPoint,
      originalEvent: event.originalEvent,
    })
  })
});

 function latlngDisplay(e) {
   document.getElementById('latlng-display').innerHTML = 'lat: '+parseFloat(e.latlng.lat).toFixed(4)+', lng: '+parseFloat(e.latlng.lng).toFixed(4);
 }

  function pointData(latlng) {
    var data = $('#sel-data-type')[0].value;
    var point = JSON.stringify({'type': 'Point', 'coordinates': [parseFloat(latlng.lng), parseFloat(latlng.lat)]});
    console.log(point);

    if (data==undefined) {
      alert('Please select a data type.');
      return;
    }

    // subscribed zone check

    $.ajax({
       type : 'GET',
       url : point_api,
       data : {'data': data, 'point': point},
       dataType: 'json',
       cache: false,
       xhrFields: {
       withCredentials: true
      },
    crossDomain: true,
       success : function(response) {
          if(response.status) {
            // display pop-up
            if (response.data) {
              console.log(response.data);
              // var content = '';
              // if (data=='waveheight') {
              //   content = 'wave-height: '+response.data[0].param;
              // } else if(data=='bathymetry') {
              //   content = 'depth: '+response.data[0].param;
              // } else if(data=='wavedirection') {
              //   content = 'wave-direction: '+response.data[0].param;
              // } else if(data=='waveperiod') {
              //   content = 'wave-period: '+response.data[0].param;
              // }
              // d3-chart
              var margin = {
                  top: 30,
                  right: 20,
                  bottom: 30,
                  left: 50
              };
              var width = 600 - margin.left - margin.right;
              var height = 270 - margin.top - margin.bottom;

              var parseDate = d3.timeParse("%Y-%m-%d-%I");

              var x = d3.scaleTime().range([0, width]);
              var y = d3.scaleLinear().range([height, 0]);

              var xAxis = d3.axisBottom(x)
              //.tickArguments([20, 'm'])

              var yAxis = d3.axisLeft(y)
              //.tickArguments([d3.timeMinute.every(6*60)])

              // var xAxis = d3.svg.axis().scale(x)
              //   .orient("bottom").ticks(5);

              // var yAxis = d3.svg.axis().scale(y)
              //   .orient("left").ticks(5);
              
              var valueline = d3.line()
              .x(function (d) {return x(d.d);})
              .y(function (d) {return y(d.v);});

              var div = $('<div id="chart" style="width:650px;height:300px;"><svg/></div>')[0];
              var popup = L.popup({maxWidth : 750}).setLatLng([parseFloat(latlng.lat), parseFloat(latlng.lng)]).setContent(div).openOn(map);
              var svg = d3.select('#chart svg')
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

              response.data.forEach(function (d) {
                d.d = parseDate(d.d);
                d.v = +d.v;
              });

              // Scale the range of the data
              x.domain(d3.extent(response.data, function (d) {return d.d;}));
              y.domain([0, d3.max(response.data, function (d) {return d.v;})]);

              // Add the valueline path.
              svg.append("path") 
              .data([response.data])
              .attr("class", "line")
              .attr("d", valueline);

              // Add the X Axis
              svg.append("g") 
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

              // Add the Y Axis
              svg.append("g") 
                .attr("class", "y axis")
                .call(yAxis);


              // svg.append("circle").style("stroke", "gray").style("fill", "white").attr("r", 100).attr("cx", 100).attr("cy", 100).on("mouseover", function () {
              //     d3.select(this).style("fill", "aliceblue");
              // }).on("mouseout", function () {
              //     d3.select(this).style("fill", "white");
              // });
            }
            console.log(div);
          } else{
            alert(response.msg);
          }
       },
       error : function(xhr) {
         alert('Server is down. Please try after sometime.');
       },
    });
  }

function addControlPlaceholders(map) {
	var corners = map._controlCorners,
        l = 'leaflet-',
        container = map._controlContainer;

    function createCorner(vSide, hSide) {
        var className = l + vSide + ' ' + l + hSide;

        corners[vSide + hSide] = L.DomUtil.create('div', className, container);
    }

    createCorner('verticalcenter', 'left');
    createCorner('verticalcenter', 'right');
}
addControlPlaceholders(map);
map.zoomControl.setPosition('verticalcenterright');


var featureGroup = L.featureGroup().addTo(map);
var drawControl = new L.Control.Draw({
	position:'verticalcenterright',
	draw:{
		polyline:false,
		circle:false,
		rectangle:false,
		marker:false
	},
    edit: {
      featureGroup: featureGroup
    }
  }).addTo(map);




 
var button_draw = document.getElementById('draw');
button_draw.onclick = function(){
	new L.Draw.Polygon(map,drawControl.options.polygon).enable();
}
	
// var button_edit = document.getElementById('edit');
// button_edit.onclick = function(){
//     new L.EditToolbar.Edit(map, drawControl.options.polygon).enable();
// }
  map.on('draw:created', function(e) {
      featureGroup.addLayer(e.layer);
      getprice(e.layer);
      
  });

  map.on('draw:edited',function(e){
    getprice(e.layer);
  })

  map.on('draw:drawstart',function(e){

    if(!login_flag) { $("#login").modal('open'); return;}
  })





//request params


var client = new XMLHttpRequest();
client.open('GET', host+'/download/heatmap/');
client.onreadystatechange = function() {  
 	heatmap_data = client.responseText;
    heatmap_data = JSON.parse(heatmap_data);
 	heatmap_data.data = make_heat_format(heatmap_data.data);
 	// if(heatmap_data.status){
 	// 	console.log(heatmap_data.data)
 	// var heat = L.heatLayer(heatmap_data.data,{maxZoom:12,gradient:{0:'blue',0.5:'#64F0FA',1:'#F1F743'},minOpacity:0.2,radius:15,blur:10}).addTo(map,true);
 	// }
}
client.send();
make_heat_format = function(data){
	data = JSON.parse(data);
	console.log(data);
	var f=[];
	var item = [];
	for(var i = 0;i<data.length;i++) {
		item = [];
		item[0] = data[i][2];
		item[1] = data[i][1];
		item[2] = data[i][0];
		f[i]=item;
	}
	return f;

}

/// *********************************************** draw polygon ***********************************///

getcord = function(data) {
    var c=[];
    for(i=0;i<data.length;i++) {

        var item = [];
        item[0] = data[i]['lng'];
        item[1] = data[i]['lat'];
        c[i] = item;
    }
    c.push(c[0]);
    return c;
}

geoJson_to_poly = function(data){
    var r = [];
    for(var i=0;i<data.length;i++){
        r.push(data[i].geometry.coordinates[0]);
    }
    console.log(r);
    return r;
}

seperate_hd = function(data ) {   // case when the hd region is named alphabetwise. 
    var s = data;
    for(i=0;i<s.length;i++) {var index = s.findIndex(x => isNaN(x.properties.name));
    s.splice(index,1); 
    }
    return s;
}
getprice = function(layer) {
  
	console.log(layer);
    if (layer._latlngs[0].length>2 ) {
        
        var cordinates = [];
        cordinates[0] = getcord(layer._latlngs[0]);
    	polygon_check=true;
    	var area = (LGeo.area(layer) / 1000000).toFixed(2);
        geo_json_data = {"type":"Polygon"};
        geo_json_data["coordinates"] = cordinates;
        // restrict to area to 2 decimal points
       check_intersect();
        var answer = document.getElementById('calculated-area');
        answer.innerHTML = '<p><strong>' + area + 'kms<sup>2</sup> </strong></p>';
        datatype = $('#sel-data-type').val();
        if (datatype != 'bathymetry') {
          month = document.getElementById('sel-month').value;
          // datefrom = document.getElementById('datefrom').value;
          // dateto = document.getElementById('dateto').value;
          // console.log(datatype);
          // console.log(datefrom + '&' + dateto);
         // if(!isNaN(datefrom)) return;
         //  if(!isNaN(dateto)) return;
         //  datefrom = new Date(datefrom).toISOString();
         //  dateto = new Date(dateto).toISOString();
        }

        
    //request.open(method,price_api+'data='+data_type+'&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data),async);
    request.open(method,price_api+'data='+data_type+'&month='+month+'&polygon='+JSON.stringify(geo_json_data),async);
		request.setRequestHeader("Content-type","application/json;charset=UTF-8");
		request.send();
		request.onload = function(){
			var status = request.status;
			var data = JSON.parse(request.responseText);
			console.log(data.price,status);
            if(data.status) {
			answer.innerHTML += '<p> Datapoints '+ data.datapoints + '</p>'+ '</br> <p> Size '+ data.size + '</p>' ;
		    }
            else { alert('Hi, Please ensure you select the dates')}  
        }


	 
    } else {
        alert("Use the draw tools to draw a polygon!");
    }
};

check_intersect = function() {
    var zone_cords = geoJson_to_poly(boundary_zones);
    intersect = false;
    var draw =  turf.polygon(geo_json_data['coordinates']);
    var l=0;
    var index=[];
    for(i=0;i<zone_cords.length;i++) {
    var zone = turf.polygon([zone_cords[i]]);
    //var subscription_zones = turf.polygon(geoJson_to_poly(geoJson_sub));
    var inter1 = turf.intersect(draw,zone);
    if(!inter1) l++;
    else index.push(i);  // only when index has one element , the value is used. so by default index[0]. array of intersected zones. 
  }
  console.log(l);
  if(index.length==0) { alert('Please draw your polygon within your subscribed zone.'); }
  else if(index.length>1) { alert('Please draw your polygon within a single zone.'); intersect=true;  }
  else {
    var zone_id = boundary_zones[index[0]].properties.zid ;
    var index = user_details.subscription_zones.findIndex(x=> x == zone_id);
    if(index==-1) { alert('Please draw your polygon within your subscribed zone'); intersect=true; };
  }

}

var orderButton = document.getElementById('submit');
orderButton.onclick = function(){
    if(!login_flag){$('#login').modal('open'); return;}
	if(polygon_check ) {
        if(intersect) { alert('Unable to send request. Please redraw your area.'); return;}
        console.log('clicked');
        var url_order;
        if(data_type=='bathymetry') url_order = order_api+'&data='+data_type+'&polygon='+JSON.stringify(geo_json_data);
        else url_order = order_api+'&data='+data_type+'&month='+month+'&polygon='+JSON.stringify(geo_json_data);
        //else url_order = order_api+'&data='+data_type+'&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data); 
	request.open(method,url_order,async);
	request.send();
	request.onload = function(){
		var status = request.status;
    if(status==200) {
		var	data = JSON.parse(request.responseText);
			console.log(data,status);
            if(data.status){
                alert('Thank you. your order has been placed. A mail with the download link will be sent to '+user_details.email);
                form_reset();
            }
            else {
                alert('Please try again.');
            }
	}
  else if(status==500) {
    alert('Server under maintainenace. Please try Downloading after 30 min.');
  }
  }

}
else {
	alert("Use the draw tools to draw a polygon!");
}
};

// *******************************************************************************************//

//*******************************************************Visualisation****************************************//

function getWaveColor (d) {
  return d == null ? '':
         d < 0.2 ?  '#8B71FA' :
         d < 0.4 ?  '#7CACFF' :
         d < 0.6 ? '#55EAFF' :
         d < 0.8  ?   '#35FCE1' :
         d < 1 ? '#4DEEB8' :
         d < 1.5  ? '#55E08A' :
                    '#A0F081';
}

function waveheight_Style (feature) {
  
    return {
      fillColor: getWaveColor(feature.properties.wave_height),
      color: " #cecccc",
      weight: 0,
      fillOpacity:0.7
    };
}

function getBathymetryColor (d) {
  return d > -10 ? '#B24A2A' :
         d > -20  ? '#C86339' :
         d > -50 ? '#F19D2B' :
         d > -100  ? '#F6C550' :
         d > -500  ? '#FAED9D' :
         d > -1000  ? '#E2E0D0' :
         d > -5000  ? '#A69BBC' :
                    '#5A58AC';
}

function bathymetry_Style (feature) {
  
    return {
      fillColor: getBathymetryColor(feature.properties.bathymetry),
      color: " #cecccc",
      weight: 0,
      fillOpacity:0.7
    };
}

function getBathymetryHDColor (d) {
  return d > -1 ? '#B24A2A' :
         d > -1.5  ? '#C86339' :
         d > -2  ? '#F19D2B' :
         d > -3  ? '#F6C550' :
         d > -5  ? '#FAED9D' :
         d > -8  ? '#E2E0D0' :
         d > -10  ? '#A69BBC' :
                    '#5A58AC';
}

function bathymetryHD_Style (feature) {
  
    return {
      fillColor: getBathymetryColor(feature.properties.bathymetry),
      color: " #cecccc",
      weight: 0,
      fillOpacity:0.7
    };
}

/// ################## UPLOAD DATA ######################
uploadData =  function() {
  var csv = document.getElementById('csv-file').files[0];
  var name = document.getElementById('zone-name').value;
  if (csv==undefined || name.trim()==undefined) {
    alert('Please fill all the fields.');
    return;
  }
  if (csv.name.indexOf('.csv') === -1) {
    alert('Please upload a .csv file.');
    return;
  }

  var formData = new FormData($('#upload-form')[0]);
  
  $.ajax({
     type : 'POST',
     enctype: 'multipart/form-data',
     url : upload_api,
     data : formData,
     processData: false,  // tell jQuery not to process the data
     contentType: false,  // tell jQuery not to set contentType
     cache: false,
     success : function(response) {
         console.log(response);
         alert(response);
     },
  });


};

 
 // ************************ slider *************************************************************************************//

 var slider = document.getElementById('year-slider');

  noUiSlider.create(slider, {
   start: [timestamp(s_latest_year.toString())],
   connect: true,
   step: 365*24*60*60*1000, //steps of one month
    orientation: 'horizontal', // 'horizontal' or 'vertical'
   range: {
     'min': timestamp('2010-01-10'),
     'max': timestamp(s_latest_year.toString())
   },
   format: wNumb({
     decimals: 0
   })
  });

  function timestamp(str){
    return new Date(str).getTime();   
}

function formatDate ( date ) {
    //weekdays[date.getDay()] + ", " +
    // date.getDate() + nth(date.getDate()) + " " +
    //     months[date.getMonth()] + " " +
    return months[date.getMonth()] + " " +" "+
        date.getFullYear();
}
var
  weekdays = [
    "Sunday", "Monday", "Tuesday",
    "Wednesday", "Thursday", "Friday",
    "Saturday"
  ],
  months = [
    "January", "February", "March",
    "April", "May", "June", "July",
    "August", "September", "October",
    "November", "December"
  ];

// Append a suffix to dates.
// Example: 23 => 23rd, 1 => 1st.
function nth (d) {
  if(d>3 && d<21) return 'th';
  switch (d % 10) {
        case 1:  return "st";
        case 2:  return "nd";
        case 3:  return "rd";
        default: return "th";
    }
}

var dateValues = [
  document.getElementById('year-slider-start'),
];

slider.noUiSlider.on('update',function(values,handle){
    dateValues[handle].innerHTML = formatDate(new Date(+values[handle]));
    shoreline_update(slider.noUiSlider.get());

});

//keyboard support
var handle = slider.querySelector('.noUi-handle');
handle.addEventListener('click', function(){
  this.focus();
});

handle.addEventListener('keydown', function( e ) {

  var value = Number( slider.noUiSlider.get() );

  switch ( e.which ) {
    case 37: slider.noUiSlider.set( value - 365*24*60*60*1000 );
      break;
    case 39: slider.noUiSlider.set( value + 365*24*60*60*1000 );
      break;
  }
});


//**********************************************browser detect*************************************************//

function detect() { 
     if((navigator.userAgent.indexOf("Opera") || navigator.userAgent.indexOf('OPR')) != -1 ) 
    {
        prevent_display();    }
    else if(navigator.userAgent.indexOf("Chrome") != -1 )
    {
        return;
    }
    else if(navigator.userAgent.indexOf("Safari") != -1)
    {
       prevent_display(); 
    }
    else if(navigator.userAgent.indexOf("Firefox") != -1 ) 
    {
         //alert('Firefox');
        return;
    }
    else if((navigator.userAgent.indexOf("MSIE") != -1 ) || (!!document.documentMode == true )) //IF IE > 10
    {
      prevent_display(); 
    }  
    else 
    {
       prevent_display(); 
    }
    }

    

    function prevent_display() {
            $('#browser_detect_modal').modal('open');
    }

    function addCloseHandler($modal, handler) {
          var modal = $modal[0].M_Modal;
          modal._close = modal.close;
          modal.close = function () { handler(function () { modal._close(); }) };
        } 

    
</script>
</body>
</html>
