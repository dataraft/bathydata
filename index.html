<!DOCTYPE html>
<html lang="en">
<head >
	<meta charset=utf-8 />

<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />


</head>
<body style='margin:0 !important; padding:0 !important'>
	<script
			  src="https://code.jquery.com/jquery-3.2.1.min.js"
			  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			  crossorigin="anonymous"></script>
	
	<script src="https://unpkg.com/vue-router@2.0.0/dist/vue-router.js" > </script>

	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.css' rel='stylesheet' />
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>


	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<link rel="stylesheet" href="style.css" />	
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
	<nav style="background-color: #00517f; position: absolute; z-index: 1000000">
    <div class="nav-wrapper">
      <a href="#" class="brand-logo">Dataraft  </a>  

      <ul id="nav-mobile" class="right hide-on-med-and-down">
        <li><a href="aboutus.html">About Us</a></li>
        <li><a href="badges.html">Contact Us</a></li>
        <!-- <li><a href="collapsible.html">Checkout</a></li> -->
      </ul>
    </div>
  </nav>
	<div id='map' style='position:absolute; top:0; bottom:0; width: 100%;'></div>
	<div style="position: absolute; top:64px;lef:0px; width:20vw;  z-index: 100000">
	  <ul class="collapsible" data-collapsible="accordion">
	    <li>
	      <div class="collapsible-header active">1. Choose Data type </div>
	      <div class="collapsible-body"><div class="input-field col s6"><select multiple id="sel-data-type"> <option value="wave">Wave</option> <option value="Time period">Time Period </option> <option value="Tide"> Tide </option> <option value="bathymetry">Bathymetry </option>	 </select> <label> Data types </label> </div>
	      <label for="datefrom">From</label>
	      <input type="date" id="datefrom" class="datepicker col s6 m2"> 
	      <label for="dateto">To </label>
	      <input type="date" id="dateto" class="datepicker col s6 m2">
	      
	  </div>
	    </li>
	    <li>
	      <div class="collapsible-header">2. Select your area</div>
	      <div class="collapsible-body"><span> <p> Draw a polygon in the box </p> <button id="draw"> Draw</button> <!-- <button id="edit"> Edit </button> --> <div id='calculated-area'></div></span> </div>
	    </li>
	    <li>
	      <div class="collapsible-header">3. Checkout </div>
	      <div class="collapsible-body"> <div class="row">
    <form class="col s12">
      <div class="row">
        <div class="input-field col s12">
          <input id="email" type="email" class="validate">
          <label class="active" for="email" data-error="wrong" data-success="right">Email</label>
        </div>
      </div>
      <div class="input-field col s12">
      <input value="dataraft" id="organisation" type="text" class="validate">
      <label  for="organisation">Organisation</label>
    </div>
    </form>
  </div><span>Proceed to checkout <button id="submit"> Order </button> </span></div>
	    </li>
	  </ul>
      </div>

	<script>
		 $(document).ready(function() {
    $('select').material_select();
    $(".button-collapse").sideNav();
  });

		 $('.datepicker').pickadate({
    selectMonths: true, // Creates a dropdown to control month
    selectYears: 15, // Creates a dropdown of 15 years to control year,
    today: 'Today',
    clear: 'Clear',
    close: 'Ok',
    closeOnSelect: false // Close upon selecting a date,
  });

	

L.mapbox.accessToken = 'pk.eyJ1Ijoic2hhc2hhbmsxOTkyIiwiYSI6ImNqODFneGcxNjZ2Z2EycXQ2a21kc3g5MnkifQ.93wfkOvX-_T9RrDA6PXmMA';
var price_api = 'http://ocean.dataraft.in/download/price/?';
var order_api = 'http://ocean.dataraft.in/download/order/?';
var map = L.mapbox.map('map','mapbox.streets').setView([5,70],2);

function addControlPlaceholders(map) {
	var corners = map._controlCorners,
        l = 'leaflet-',
        container = map._controlContainer;

    function createCorner(vSide, hSide) {
        var className = l + vSide + ' ' + l + hSide;

        corners[vSide + hSide] = L.DomUtil.create('div', className, container);
    }

    createCorner('verticalcenter', 'left');
    createCorner('verticalcenter', 'right');
}
addControlPlaceholders(map);
map.zoomControl.setPosition('verticalcenterright');


var featureGroup = L.featureGroup().addTo(map);
var drawControl = new L.Control.Draw({
	position:'verticalcenterright',
	draw:{
		polyline:false,
		circle:false,
		rectangle:false,
		marker:false
	},
    edit: {
      featureGroup: featureGroup
    }
  }).addTo(map);
 
var button_draw = document.getElementById('draw');
button_draw.onclick = function(){
	new L.Draw.Polygon(map,drawControl.options.polygon).enable();
}
	
// var button_edit = document.getElementById('edit');
// button_edit.onclick = function(){
//     new L.EditToolbar.Edit(map, drawControl.options.polygon).enable();
// }
  map.on('draw:created', function(e) {
      featureGroup.addLayer(e.layer);
      
      getprice(e.layer);
      
  });

  map.on('draw:edited',function(e){
    getprice(e.layer);
  })




//request params

var heatmap_data;
var client = new XMLHttpRequest();
client.open('GET', 'http://ocean.dataraft.in/download/heatmap/');
client.onreadystatechange = function() {  
 	heatmap_data = JSON.parse(client.responseText);
 	heatmap_data.data = make_heat_format(heatmap_data.data);
 	if(heatmap_data.status){
 		console.log(heatmap_data.data)
 	var heat = L.heatLayer(heatmap_data.data,{maxZoom:32,max:1,gradient:{0:'blue',0.5:'yellow',1:'red'},minOpacity:0.2,radius:12,blur:5}).addTo(map);
 	}
}
client.send();
make_heat_format = function(data){
	data = JSON.parse(data);
	console.log(data);
	var f=[];
	var item = [];
	for(var i = 0;i<data.length;i++) {
		item = [];
		item[0] = data[i][2];
		item[1] = data[i][1];
		item[2] = data[i][0];
		f[i]=item;
	}
	return f;

}

var method = "GET";
var async = true;
var request = new XMLHttpRequest();
var datatype;
var email;
var organisation;
var geo_json_data = {};
var calcButton = document.getElementById('calculate');
var datefrom;
var dateto;
var polygon_check = false;
getcord = function(data) {
    var c=[];

    for(i=0;i<data.length;i++) {
        var item = [];
        item[0] = data[i]['lng'];
        item[1] = data[i]['lat'];
        c[i] = item;
    }
    return c;
}

getprice = function(layer) {
	console.log(layer);
    if (layer._latlngs[0].length>2 ) {
        var cordinates = getcord(layer._latlngs[0]);
    	polygon_check=true;
    	var area = (LGeo.area(layer) / 1000000).toFixed(2);
        geo_json_data = {'type':'Polygon'};
        geo_json_data['coordinates'] = JSON.stringify(cordinates);
        // restrict to area to 2 decimal points
       
        var answer = document.getElementById('calculated-area');
        answer.innerHTML = '<p><strong>' + area + 'kms<sup>2</sup> </strong></p>';
        datatype = $('#sel-data-type').val();
        datefrom = document.getElementById('datefrom').value;
        dateto = document.getElementById('dateto').value;
        console.log(datatype);
        datefrom = new Date(datefrom).toISOString();
        dateto = new Date(dateto).toISOString();

        
        request.open(method,price_api+'data=wave&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data),async);
		request.setRequestHeader("Content-type","application/json;charset=UTF-8");
		request.send();
		request.onload = function(){
			var status = request.status;
			var data = JSON.parse(request.responseText);
			console.log(data.price,status);
            if(data.status) {
			answer.innerHTML += '<p> Price '+ data.price + '</p>';
		    }
            else { alert('Hi, Please ensure you select the dates')}  
        }

	 
    } else {
        alert("Use the draw tools to draw a polygon!");
    }
};

form_reset = function(){
    document.getElementById('sel-data-type').reset();
    document.getElementById('datefrom').reset();
    document.getElementById('dateto').reset();
}
var orderButton = document.getElementById('submit');
orderButton.onclick = function(){
	if(polygon_check) {
        console.log('clicked');
	var email = $("#email").val();
	var organisation = $("#organisation").val();
	request.open(method,order_api+'email='+email+'&organization='+organisation+'&data=wave&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data),async);
	request.send();
	request.onload = function(){
		var status = request.status;
		var	data = JSON.parse(request.responseText);
			console.log(data,status);
            if(data.status){
                alert('Thank you. your order has been placed. A mail with the download link has been sent to you');
                form_reset();
            }
	}

}
else {
	alert("Use the draw tools to draw a polygon!");
}
}


</script>
</body>
</html>