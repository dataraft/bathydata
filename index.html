<!DOCTYPE html>
<html lang="en">
<head >
	<meta charset=utf-8 />

<script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.1/mapbox-gl.css' rel='stylesheet' />

 <link rel="icon" href="images/favicon.ico" type="image/x-icon">
 <title>Oceanographic database</title>
</head>
<body style='margin:0 !important; padding:0 !important'>
	<script
			  src="https://code.jquery.com/jquery-3.2.1.min.js"
			  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
			  crossorigin="anonymous"></script>
	
	<script src="https://unpkg.com/vue-router@2.0.0/dist/vue-router.js" > </script>

	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.css' rel='stylesheet' />
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.4.10/leaflet.draw.js'></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>

   
   <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<link rel="stylesheet" href="style.css" />	
    <link rel="stylesheet" href="login/style.css" />
    <link rel="stylesheet" href="pricing/style.css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css">
    <script type="text/javascript" src="bootstrap.min.js"></script>
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
	<nav style="background-color: #fcfcfc; position: absolute; z-index: 1000; height:7vh; line-height: 7vh !important;">
    <div class="nav-wrapper">
      <a href="#" class="brand-logo" style="color:#004165; padding-left: 20px; font-weight: 400;">   SAMUDRA   </a> 
      <!-- <span> Oceanographic Database</span> -->    
      <ul id="nav-mobile" class="right hide-on-med-and-down">
        <li><a href="#faq" class=" modal-trigger" > FAQ </a></li>
        <li><a href="#pricing"   class=" modal-trigger" onclick="pricing()" > Subscription </a></li>
        <li><a href="#contact" class=" modal-trigger" > Contact </a></li>
        <li><a href="#aboutus" class=" modal-trigger" > About Us </a></li>
        <!--<li><a href="#"  > <button type="button" data-target="select-area" class="btn modal-trigger">Select-Area </button></a></li>-->
        <li><a href="#login" id="login-btn"   class=" modal-trigger"><button type="button" class="btn"> Login </button> </a></li>
        <li id="logout-btn" style="display:none"><a class='dropdown-button ' href="#logout" data-activates='dropdown1' id="login-text"   >   </a> <span class="badge" style="right:0; top:5vh; padding-left: 0;"> <i class="material-icons tiny" style="height:0.8vh; line-height: 0.8vh">arrow_drop_down</i></span> </li> <ul id='dropdown1' class="dropdown-content" > <li> <a href="#" onclick="logout()"> Logout </a> </li> 
        </ul>
         <!-- <li><a href="collapsible.html">Checkout</a></li> -->
      </ul>
    </div>
  </nav>
  <div id="login" class="modal">
    <div class="modal-content">
      <div class="login-page">
                  <div class="form">
                    <form id="register-form" class="register-form">
                        <!-- <button onclick="choose_area()">Choose your plan </button> -->
                      <input type="text" required placeholder="name"/>
                      <input type="email" required placeholder="email address"/>
                      <input type="password" required placeholder="password"/>
                      <input type="number" required placeholder="contact number"/>
                      <input type="text" required placeholder="Organisation"/>
                      <button type="button" onclick="signup()">NEXT</button>
                      <p class="message">Already registered? <a href="#">Sign In</a></p>
                    </form>
                    <form id="login-form" class="login-form">
                      <input type="text" required placeholder="username"/>
                      <input type="password" required placeholder="password"/>
                      <button type="button" onclick="login()">login</button>
                      <p class="message">Not registered? <a href="#">SignUp</a></p>
                    </form>
                  </div>
        </div>
    </div>
     <div class="modal-footer">
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn-flat ">Close</a>
    </div>
  </div>
  <div id="select-area" class="modal modal-fixed-footer">
                  
    <div class="modal-content" style="height: 68vh"> 
    <div id='map2' style=" width: 100%; height: 85%"></div>
    <label style="float: left;">Click on the highlighted regions to choose the zone </label>
          <div class="chips chips-initial "></div>
    </div>
    <div class="modal-footer">        
        
          
      <a href="#!" class="modal-action modal-close waves-effect waves-green btn " onclick="select_area_next()"> Proceed</a>
    </div>
  </div>
  <div id="faq" class="modal">
    <div style="text-align: center;color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> Frequently Asked Questions </div>
    <div style="padding-left: 20px"><b> Why am I unable to draw a polygon across zones?</b></div>
    <div style="padding-left: 20px"> Polygon should be limited to a single zone. You cannot draw a polygon across zones.</div><br/>
  </div> 
  <div id="contact" class="modal" style="text-align: center;">
    <span style="color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> Contact Us </span>
    <div>For any queires or requests please contact us at</div><br>
    <div><b>Email:</b> help@dataraft.in</div><br/>
    <div><b>Phone:</b> +91 7827824852</div><br/>
    <div><b>Address:</b> 03-A2 3rd Floor, IITM Research Park, Kanagam Road, Taramani, Chennai, Tamil Nadu - 600113</div><br/>
  </div>
  <div id="aboutus" class="modal" style="text-align: center;">
    <span style="color:#004165 !important; font-family: 'Trocchi', serif; font-size: 25px; font-weight: normal; line-height: 48px; margin: 0; "> About Us </span>
    <button class="modal-close btn-flat" style="position:absolute;top:0;right:0;">
      <i class="material-icons">close</i>
            </button>
            <div class="modal-content">
            <div class="row">
                <div class="col s12 m4">
                <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/Prof_SUNDAR.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4">Prof.V.Sundar, IIT Madras<i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/vsundar/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.V.Sundar, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

            <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/prof_murali.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.K.Murali, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/murali/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.K.Murali, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

              <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/prof_Sannasiraj.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.Sannasiraj, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/sasraj/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.Sannasiraj, IIT Madras<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

               
          </div> 
            <div class="row">

                <div class="col s12 m4">
                <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/Assi_Prof_sriram.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Prof.V.Sriram, IIT Madras <i class="material-icons right">more_vert</i></span>
                  <p><a href="http://www.doe.iitm.ac.in/vsriram/" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Prof.V.Sriram<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

              <div class="col s12 m4">
              <div class="card">
                <div class="card-image waves-effect waves-block waves-light">
                  <img class="activator" src="images/dr.chitra.jpg">
                </div>
                <div class="card-content">
                  <span class="card-title activator grey-text text-darken-4"> Dr.K.Chitra <i class="material-icons right">more_vert</i></span>
                  <p><a href="#" target="_blank">Visit Website</a></p>
                </div>
                <div class="card-reveal">
                  <span class="card-title grey-text text-darken-4">Dr.K.Chitra<i class="material-icons right">close</i></span>
                  <p>With over 40 years of expertise in ocean consultancy projects, has been the person behind many coastal projects and protection measures by the Indian Government. </p>
                </div>
                </div>
              </div>

            </div>
            </div>
            
  </div>   
  <div id="pricing" class="modal modal-fixed-footer">

    <div class="modal-content">
      <section class="container">
              <div class="row white">
                            <div class="block">

                                <div class="col-xs-12 col-sm-6 col-md-3" style="float:left; width: 50%!important;">
                                        <ul class="pricing p-green">
                                            <li>
                                                <img src="" alt="">
                                                <big>Plan A</big>
                                            </li>
                                            <li>Basic Resolution Data</li>
                                            <li>25 Downloads per month</li>
                                            <li>1 GB Cloud Storage </li>
                                            <li>
                                                <h3>$199</h3>
                                                <span>per month</span>
                                            </li>
                                        </ul>
                                </div>

                                <div class="col-xs-12 col-sm-6 col-md-3" style="float: right; width: 50% !important;">
                                        <ul class="pricing p-blue">
                                            <li>
                                                
                                                <big>Plan B</big>
                                            </li>
                                            <li>High Resolution Data</li>
                                            <li>100 Downloads per month</li>
                                            <li>5 GB Cloud Storage</li>
                                            <li>
                                                <h3>$799</h3>
                                                <span>per month</span>
                                            </li>
                                        </ul>
                                </div>


                            </div><!-- /block -->
                        </div><!-- /row -->
             </section>

    </div>
    <button class="modal-close btn-flat" style="position:absolute;top:0;right:0;">
      <i class="small material-icons">close</i>
            </button>
    <div class="modal-footer">
        <span style="float:left;" id="planid"></span>    
      <!--<a href="#!" class="modal-action modal-close waves-effect waves-green btn ">Submit</a>-->
    </div>
  </div>

	<div id='map' style='position:absolute; top:0; bottom:0; width: 100%;'></div>
	<div style="position: absolute; top:64px;left:0px; width:20vw;  z-index: 100">
	  <ul class="collapsible" data-collapsible="accordion">
	    <li>
	      <div class="collapsible-header active">1. Choose Data type </div>
	      <div class="collapsible-body" id="div-sel-data"><label for="data_types"> Data types </label><div id="data_types" class="input-field col s6"><select  id="sel-data-type"> <option value="wave" selected >Wave</option> <!-- <option value="Time period">Time Period </option> <option value="Tide"> Tide </option> --> <option value="bathymetry">Bathymetry </option>	 </select>  </div>
	      <div id="dates">
          <label for="datefrom">From</label>
	      <input type="date" id="datefrom" class="datepicker col s6 m2"> 
	      <label for="dateto">To </label>
	      <input type="date" id="dateto" class="datepicker col s6 m2">
         </div>
          <!-- <label for="switch">Data Resolution </label>
          <div id="switch" class="input-field col s12">
            <select onchange="changeFunc(value);">
              <optgroup label="Free Plan">
                <option value="1">BASIC</option>
              </optgroup>
              <optgroup label="Premium Plan">
                <option value="2" disabled>NORMAL</option>
                <option value="3" disabled>HIGH</option>
              </optgroup>
            </select>
          </div> -->
	  </div>
	    </li>
	    <li>
	      <div class="collapsible-header">2. Select your area</div>
	      <div class="collapsible-body"><span> <p> Draw a polygon in the colored regions </p> <button class="btn" id="draw"> Draw</button> <!-- <button id="edit"> Edit </button> --> <div id='calculated-area'></div></span> </div>
	    </li>
	    <li>
	      <div class="collapsible-header">3. Download </div>
	      <div class="collapsible-body"> <div class="row">
    <!-- <form class="col s12">
      <div class="row">
        <div class="input-field col s12">
          <input id="email" type="email" class="validate">
          <label class="active" for="email" data-error="wrong" data-success="right">Email</label>
        </div>
      </div>
      <div class="input-field col s12">
      <input value="dataraft" id="organisation" type="text" class="validate">
      <label  for="organisation">Organisation</label>
    </div>
    </form> -->
  </div> <div><button class="btn" id="submit"> Download </button></div> 
	    </li>
	  </ul>
      </div>

	<script>

        //****************************************************Global varaibles*************************************************//

        var zone; //zones the user needs to update
        var zone_local=[]; // store the zone names and ids in local.
        var zone_array=[];  
        var zone_boundary; // the overall boundary latlongs of all zones
        var pricing_flag ;
        var inputs_register ;
        var plan_variable; //plan a or b
        var maps = {};
        var boundary_layer;
        var geoJson
        var session_api = 'http://ocean.dataraft.in/download/login/';
        var login_api = 'http://ocean.dataraft.in/download/login/?email=';
        var signup_api = 'http://ocean.dataraft.in/download/signup/?email=';
        var price_api = 'http://ocean.dataraft.in/download/price/?';
        var order_api = 'http://ocean.dataraft.in/download/order/?';
        var logout_api = 'http://ocean.dataraft.in/download/logout/';
        var user_details;
        var login_flag = false;
        var data_type = 'wave';
        var user_layer= []; //users selected zone boundary latlongs
       // var user_layer_map;   //layer added to map of user_layer
        var geoJson_sub;                      

                                  //map related//

        var heatmap_data;
        var method = "GET";
        var async = true;
        var request = new XMLHttpRequest();
        var datatype;
        var email;
        var organisation;
        var geo_json_data = {}; //user drawn coordinates jeojson
        var calcButton = document.getElementById('calculate');
        var datefrom;
        var dateto;
        var polygon_check = false;
        var map;
        //*********************************************Loading Map2**********************************************//
        session_call = function(url,val){
            console.log(val + url);
        var client = new XMLHttpRequest();
        client.onreadystatechange = function(){
            var response = JSON.parse(this.responseText);
            if(this.readyState == 4 && this.status==200){
            if(response.status){
                user_details = response.data;
                console.log(user_details);
                       login_flag = true;
            login_flip();
            load_zones();   
            if(val==1) {
            $('#login').modal('close');
            }
            }
            else {                  //val =1 implies coming from login
                if(val==1){
                alert(response.msg);
                }
            }
           } 
        }
	client.open('GET', url, true);
	client.setRequestHeader('Content-Type', 'application/json');
	client.withCredentials = true;
        client.send();
        }
        
        L.mapbox.accessToken = 'pk.eyJ1Ijoic2hhc2hhbmsxOTkyIiwiYSI6ImNqODFneGcxNjZ2Z2EycXQ2a21kc3g5MnkifQ.93wfkOvX-_T9RrDA6PXmMA';
        
        maps.map2 = L.mapbox.map('map2','mapbox.streets').setView([13,80],5);
        var boundary_client = new XMLHttpRequest();
        var boundary_latlngs = [];
        boundary_client.open('GET','http://ocean.dataraft.in/download/zone/',async)
        boundary_client.setRequestHeader("Content-type","application/json;charset=UTF-8");
        boundary_client.onreadystatechange = function(){
            if(boundary_client.readyState==4 && boundary_client.status==200){
            boundary_latlngs = JSON.parse(boundary_client.responseText).zones;
            zone_boundary = boundary_latlngs;
            // var boundary_polygon = [];
            // for(i=0;i<boundary_latlngs.length;i++){
            //     boundary_latlngs[i].geometry.coordinates[0].splice(-1,1);
            // }
            geoJson = {type:"FeatureCollection", features:boundary_latlngs};
            console.log(geoJson);
             boundary_layer = L.mapbox.featureLayer(geoJson).addTo(maps.map2)
             boundary_layer.eachLayer(function(layer){
                console.log(layer.feature.properties);
                zone_local.push(layer.feature.properties);
                layer.bindPopup('The Zone Id is ' + layer.feature.properties.name);
                layer.on('mouseover',function(){
                    layer.openPopup();
                })
                layer.on('mouseout',function(){
                    layer.closePopup();
                })  
                layer.on('click',function(){
                    check_chip_duplicate({'tag':layer.feature.properties.name});
                    $('.chips-initial').material_chip({'data':zone_array});
                    console.log($('.chips-initial').material_chip('data'));

                })

                // layer.on('click',function(e){
                //     console.log(e.target.feature.properties.name);

                // })
             })
             addTomap();
             session_call(session_api,0);
           }  
        };  
        boundary_client.send();      
        
        
  //***************************************************************jquery document.ready initializations*******************//      
    	$(document).ready(function() {
        $('select').material_select();
        $(".button-collapse").sideNav();
        $('.modal').modal({
            inDuration:0,
            outDuration:0  
        });
        if( $('#sel-data-type').val() == 'bathymetry' ) {document.getElementById("dates").style.display="none"; data_type='bathymetry'};
        $('#select-area').modal({
            inDuration:0,
            outDuration:0,
            ready:function(){
                maps.map2.invalidateSize();        
            },
            complete:function(){
                
            }

        });

        $('.dropdown-button').dropdown({
            hover:true,
            belowOrigin : true,
            alignment:'right',
            constrainWidth: false  
        })

            $('#pricing').modal({
                inDuration:0,
                outDuration:0,
                complete:function(){
                    if(pricing_flag) { pricing_flag = false; return};
                    $('#planid').empty().html('');
                    register();
                    pricing_flag = false;
                }
            })
        });

   ///************************************************************material chips ****************************//

        $('.chips-initial').on('chip.delete',function(e,chip){
            var index = zone_array.findIndex(x=> x.tag==chip.tag);
            if(index>-1){
                zone_array.splice(index,1);
            }
        });
        $('.chips-initial').on('chip.add',function(e,chip){
          check_chip_duplicate(chip);     
        })
        $('.chips-initial').material_chip({
            data:[],
            placeholder: 'Enter a tag',
            secondaryPlaceholder: '+Tag',
            minLength:1
        });
        
        check_chip_duplicate = function(chip) {
          var index = zone_array.findIndex(x=> x.tag==chip.tag);
          if(index==-1) { zone_array.push(chip);  } 
        }
  //*******************************************************ui functions & setting global variables*********************************//

        $("#sel-data-type").on('change',function(){
            data_type = $('#sel-data-type').val();
            var el = document.getElementById('dates');
            if(data_type=='bathymetry') { el.style.display = 'none'}
                else el.style.display='';
            
        });
        plan_option = function(val){
            plan_variable = val;
            $('#planid').empty().html('You have chosen Plan'+val);
            
        }

        signup = function() {
            inputs_register = document.getElementById('register-form').elements;
            choose_area();
            
        }


        pricing = function(){
            pricing_flag = true;
        }
        form_reset = function(){
            document.getElementById('register-form').reset();
            document.getElementById('login-form').reset();
            $('.chips-initial').material_chip({'data':[]});
        }
        select_area_next = function(){
                    $('#pricing').modal('open');
                    zone = $('.chips-initial').material_chip('data');
        }
        choose_area = function(){
            $('#login').modal('close');
            $('#select-area').modal('open');
        }

        form_reset = function(){
            document.getElementById('sel-data-type').reset();
            document.getElementById('datefrom').reset();
            document.getElementById('dateto').reset();
        }

        function load_zones() {
            var load_layer;
            var zones = zone_boundary;
            var index = [];
            user_layer = [];
            if(login_flag){
              console.log('went in');
            var zids = user_details.subscription_zones;   
            for(var i=0;i<zids.length;i++) {
                var ind = zones.findIndex(x => x.properties.zid == zids[i]);
                index.push(ind);
                user_layer.push(zones[ind]);
                console.log(user_layer);
            }         
              geoJson_sub = {type:"FeatureCollection", features:user_layer};
                console.log(geoJson_sub);
               var  user_layer_map = L.mapbox.featureLayer(geoJson_sub,{style: function() {return {color: "#52b840",weight: 3,fillOpacity:0.2};}

            }).addTo(map);
            }
        };
// login js
    $('.message a').click(function(){
       $('form').animate({height: "toggle", opacity: "toggle"}, "slow");
    });
    $('.datepicker').pickadate({
    selectMonths: true, // Creates a dropdown to control month
    selectYears: 15, // Creates a dropdown of 15 years to control year,
    today: 'Today',
    clear: 'Clear',
    close: 'Ok',
    closeOnSelect: false // Close upon selecting a date
  });

    function changeFunc($i){
        console.log($i);
    }



//**************************************************************register & login******************************//

login = function(){
    console.log('clicked');
    var inputs = document.getElementById('login-form').elements;
    var url = login_api + inputs[0].value + '&password='+inputs[1].value;  //login fields are bound to the form change if changed in the form
    session_call(url,1);
}


register = function(){
    var zone_list=[];
    for(i=0;i<zone_array.length;i++){
        var index = zone_local.findIndex(x=> x.name == zone_array[i].tag);
        zone_list.push(zone_local[i].zid);
    }
    var url = signup_api+inputs_register[1].value+'&password='+inputs_register[2].value+'&organization='+inputs_register[4].value+'&phone='+inputs_register[3].value+'&first_name='+inputs_register[0].value+'&subscription_zones='+JSON.stringify(zone_list)+'&subscription_type='+plan_variable+'&last_name=xyz';
    var client = new XMLHttpRequest();
    client.open('GET',url);
    client.onreadystatechange = function(){
        var r = JSON.parse(client.responseText);
        console.log(r.status);
        if(r.status=='true') { alert('Your registration is successful. Please Login.'); form_reset(); };
    }
    client.send();
}

function logout(){
    var client = new XMLHttpRequest();
    client.onreadystatechange = function(){
	if(this.readyState == 4 && this.status==200) {
            login_flag = false;
            login_flip();
            user_details=[];
             location.reload();
	}
    }
    client.open('GET', logout_api);
    client.send();    
}

function login_flip() {
    if(login_flag){
        $('#login-text').html(user_details.email);
    document.getElementById('login-btn').style.display = 'none';
    document.getElementById('logout-btn').style.display = '';

    }
    else {
        document.getElementById('login-btn').style.display = '';
        document.getElementById('logout-btn').style.display = 'none';
    }
}



//****************************************************       map           **************************************//

function addTomap() {   //ADD zones to map
    var layer_zones = L.mapbox.featureLayer(geoJson,{style: function() {return {color: " #cecccc",weight: 1,fillOpacity:0.2};}
            }).addTo(map,true);

}

 map = L.mapbox.map('map','mapbox.streets-satellite').setView([22,78],5);


function addControlPlaceholders(map) {
	var corners = map._controlCorners,
        l = 'leaflet-',
        container = map._controlContainer;

    function createCorner(vSide, hSide) {
        var className = l + vSide + ' ' + l + hSide;

        corners[vSide + hSide] = L.DomUtil.create('div', className, container);
    }

    createCorner('verticalcenter', 'left');
    createCorner('verticalcenter', 'right');
}
addControlPlaceholders(map);
map.zoomControl.setPosition('verticalcenterright');


var featureGroup = L.featureGroup().addTo(map);
var drawControl = new L.Control.Draw({
	position:'verticalcenterright',
	draw:{
		polyline:false,
		circle:false,
		rectangle:false,
		marker:false
	},
    edit: {
      featureGroup: featureGroup
    }
  }).addTo(map);




 
var button_draw = document.getElementById('draw');
button_draw.onclick = function(){
	new L.Draw.Polygon(map,drawControl.options.polygon).enable();
}
	
// var button_edit = document.getElementById('edit');
// button_edit.onclick = function(){
//     new L.EditToolbar.Edit(map, drawControl.options.polygon).enable();
// }
  map.on('draw:created', function(e) {
      featureGroup.addLayer(e.layer);
      
      getprice(e.layer);
      
  });

  map.on('draw:edited',function(e){
    getprice(e.layer);
  })




//request params


var client = new XMLHttpRequest();
client.open('GET', 'http://ocean.dataraft.in/download/heatmap/');
client.onreadystatechange = function() {  
 	heatmap_data = client.responseText;
    heatmap_data = JSON.parse(heatmap_data);
 	heatmap_data.data = make_heat_format(heatmap_data.data);
 	// if(heatmap_data.status){
 	// 	console.log(heatmap_data.data)
 	// var heat = L.heatLayer(heatmap_data.data,{maxZoom:12,gradient:{0:'blue',0.5:'#64F0FA',1:'#F1F743'},minOpacity:0.2,radius:15,blur:10}).addTo(map,true);
 	// }
}
client.send();
make_heat_format = function(data){
	data = JSON.parse(data);
	console.log(data);
	var f=[];
	var item = [];
	for(var i = 0;i<data.length;i++) {
		item = [];
		item[0] = data[i][2];
		item[1] = data[i][1];
		item[2] = data[i][0];
		f[i]=item;
	}
	return f;

}


getcord = function(data) {
    var c=[];
    for(i=0;i<data.length;i++) {

        var item = [];
        item[0] = data[i]['lng'];
        item[1] = data[i]['lat'];
        c[i] = item;
    }
    c.push(c[0]);
    return c;
}

geoJson_to_poly = function(data){
    var r = [];
    for(var i=0;i<data.length;i++){
        r.push(data[i].geometry.coordinates[0]);
    }
    console.log(r);
    return r;
}
getprice = function(layer) {
	console.log(layer);
    if (layer._latlngs[0].length>2 ) {
        
        var cordinates = [];
        cordinates[0] = getcord(layer._latlngs[0]);
    	polygon_check=true;
    	var area = (LGeo.area(layer) / 1000000).toFixed(2);
        geo_json_data = {"type":"Polygon"};
        geo_json_data["coordinates"] = cordinates;
        // restrict to area to 2 decimal points
       //check_intersect();
        var answer = document.getElementById('calculated-area');
        answer.innerHTML = '<p><strong>' + area + 'kms<sup>2</sup> </strong></p>';
        datatype = $('#sel-data-type').val();
        datefrom = document.getElementById('datefrom').value;
        dateto = document.getElementById('dateto').value;
        console.log(datatype);
        datefrom = new Date(datefrom).toISOString();
        dateto = new Date(dateto).toISOString();

        
        request.open(method,price_api+'data='+data_type+'&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data),async);
		request.setRequestHeader("Content-type","application/json;charset=UTF-8");
		request.send();
		request.onload = function(){
			var status = request.status;
			var data = JSON.parse(request.responseText);
			console.log(data.price,status);
            if(data.status) {
			answer.innerHTML += '<p> Datapoints '+ data.datapoints + '</p>'+ '</br> <p> Size '+ data.size + '</p>' ;
		    }
            else { alert('Hi, Please ensure you select the dates')}  
        }


	 
    } else {
        alert("Use the draw tools to draw a polygon!");
    }
};

check_intersect = function() {
    var zone = turf.polygon(geoJson_to_poly(zone_boundary));
    var draw =  turf.polygon(geo_json_data['coordinates']);
    //var subscription_zones = turf.polygon(geoJson_to_poly(geoJson_sub));
    var inter1 = turf.intersect(draw,zone);
    
    console.log(inter1);

}

var orderButton = document.getElementById('submit');
orderButton.onclick = function(){
    if(!login_flag){$('#login').modal('open'); return;}
	if(polygon_check) {
        console.log('clicked');
	request.open(method,order_api+'&data='+data_type+'&from_date='+datefrom+'&to_date='+dateto+'&polygon='+JSON.stringify(geo_json_data),async);
	request.send();
	request.onload = function(){
		var status = request.status;
		var	data = JSON.parse(request.responseText);
			console.log(data,status);
            if(data.status){
                alert('Thank you. your order has been placed. A mail with the download link has been sent to '+user_details.email);
                form_reset();
            }
            else {
                alert('Please fill all the fields');
            }
	}

}
else {
	alert("Use the draw tools to draw a polygon!");
}
};


 

</script>
</body>
</html>
